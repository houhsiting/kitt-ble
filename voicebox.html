<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>*-VOICEBOX REMOTE CONTROLER-*</title>

<style>
:root{
  --bg:#000000;
  --panel:#070707;
  --panel2:#0E0E0E;
  --gold:#DAA64A;
  --gold2:#B8933A;
  --red:#FF0000;
  --dim:#666666;
  --shadow1: 0 10px 18px rgba(0,0,0,.85);
  --shadow2: 0 0 24px rgba(184,147,58,.25);
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
}
.app{max-width:980px;margin:auto;padding:14px}
.frame{
  background:var(--panel);
  border:1.8px solid var(--gold2);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  box-shadow: var(--shadow1), var(--shadow2);
}
.center{display:flex; justify-content:center; align-items:center; text-align:center}
.col{display:flex; flex-direction:column; justify-content:center; align-items:center}
.row{
  width:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.pill{
  display:inline-flex;align-items:center;justify-content:center;
  padding:8px 14px;border-radius:999px;
  border:1.4px solid var(--gold);
  background:var(--panel2);
  color:var(--gold);
  font-weight:900;
  letter-spacing:1.2px;
  font-size:12px;
}
.h2{margin:0;font-size:13px;letter-spacing:1.8px;color:var(--gold);font-weight:900;}
.sub{margin-top:4px;font-size:11px;color:var(--gold2);letter-spacing:1.2px;font-weight:700;}
.mini{margin-top:4px;font-size:10px;color:var(--dim);letter-spacing:1.0px;font-weight:700;}

.btn{
  border-radius:16px;
  border:1.8px solid var(--gold2);
  background:linear-gradient(135deg,#1B1200,#0A0A0A);
  color:var(--gold);
  font-weight:900;
  letter-spacing:.9px;
  cursor:pointer;
  position:relative;
  user-select:none;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:6px;
  padding:10px 10px;
}
.btn:disabled{border-color:#2E2E2E;color:var(--dim);cursor:default;filter:saturate(.7);}
.btn.active{
  border:2.6px solid var(--red);
  box-shadow: 0 0 18px rgba(255,0,0,.55), 0 0 46px rgba(255,0,0,.35);
}
.btnSmall{
  width:118px;height:40px;border-radius:14px;
  padding:0 10px;flex-direction:row;gap:8px;letter-spacing:1.0px;
}
.btnMode{height:82px;flex:1 1 0;min-width:140px;}
.btnMode.big{height:90px;min-width:180px;}
@media (max-width:720px){.btnMode{min-width:140px;}.btnMode.big{min-width:160px;}}

.icon{width:18px;height:18px;display:block;fill:currentColor;opacity:.95;}
.iconSmall{width:16px;height:16px;}

.label{line-height:1.05;font-size:14px;font-weight:900;color:var(--gold);text-align:center;}
.label small{display:block;margin-top:3px;font-size:11px;font-weight:900;color:var(--gold2);letter-spacing:1.0px;}

.scanbar{display:flex;justify-content:center;align-items:center;gap:4px;margin-top:12px;margin-bottom:10px;}
.led{width:26px;height:12px;border-radius:4px;border:1px solid #2A0A0A;background:#140000;transition:all .12s ease;}
.led.on{background:linear-gradient(#FF3A3A,#7A0000);border-color:#FF8A8A;box-shadow:0 0 18px rgba(255,0,0,.85);}
.led.tail1{background:linear-gradient(#D02A2A,#4A0000);border-color:#C06060;box-shadow:0 0 10px rgba(255,0,0,.35);}
.led.tail2{background:linear-gradient(#5A1010,#240000);border-color:#5A2A2A;}

.kv{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}
.kv .line{
  width:100%;
  max-width:760px;
  text-align:center;
  color:var(--gold2);
  font-weight:700;
  font-size:11px;
  letter-spacing:1.1px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.kv .line.dim{color:var(--dim);font-size:10px;}

.footer{
  width:100%;
  text-align:center;
  font-size:10px;
  color:var(--dim);
  letter-spacing:1.2px;
  font-weight:600;
  margin-top:16px;
}
</style>
</head>

<body>
<div class="app">

  <div class="frame center">
    <span class="pill">*-VOICEBOX REMOTE CONTROLER-*</span>
  </div>

  <div class="frame col">
    <div class="row" style="justify-content:space-between; max-width:860px;">
      <div class="h2">SCANNER</div>
      <div class="h2" id="scannerState" style="color:var(--dim)">OFFLINE</div>
    </div>

    <div class="scanbar" id="scanbar"></div>
    <div class="sub center" id="scanText">CONNECT TO ENABLE SCAN SEQUENCE</div>
  </div>

  <div class="frame col">
    <div class="kv">
      <div class="line" id="statusText">LINK: NOT CONNECTED</div>
      <div class="line" id="bleText">BLE: UNKNOWN</div>
      <div class="line" id="deviceText">DEVICE: (none)</div>
      <div class="line dim" id="idText">ID: -</div>
    </div>

    <div style="height:10px;"></div>

    <div class="row">
      <button id="btnScan" class="btn btnSmall">
        <svg class="icon iconSmall" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm0 2a8 8 0 1 1-.001 16.001A8 8 0 0 1 12 4Zm0 3a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 7Zm0 2a3 3 0 1 1-.001 6.001A3 3 0 0 1 12 9Z"/></svg>
        <span>SCAN</span>
      </button>

      <button id="btnConnect" class="btn btnSmall" disabled>
        <svg class="icon iconSmall" viewBox="0 0 24 24"><path d="M10.59 13.41a1.996 1.996 0 0 1 0-2.82l2.83-2.83a2 2 0 1 1 2.83 2.83l-1.41 1.41 1.41 1.41 1.41-1.41a4 4 0 1 0-5.66-5.66l-2.83 2.83a4 4 0 0 0 0 5.66l.29.29 1.41-1.41-.28-.29Zm2.82 2.82a1.996 1.996 0 0 1 0 2.82l-2.83 2.83a2 2 0 1 1-2.83-2.83l1.41-1.41-1.41-1.41-1.41 1.41a4 4 0 1 0 5.66 5.66l2.83-2.83a4 4 0 0 0 0-5.66l-.29-.29-1.41 1.41.28.29Z"/></svg>
        <span>CONNECT</span>
      </button>

      <button id="btnDisconnect" class="btn btnSmall" disabled style="border-color:var(--red);">
        <svg class="icon iconSmall" viewBox="0 0 24 24"><path d="M2.1 3.51 3.51 2.1l18.39 18.39-1.41 1.41-2.83-2.83-1.41 1.41a4 4 0 1 1-5.66-5.66l1.41-1.41-2.83-2.83-1.41 1.41a4 4 0 1 1-5.66-5.66L5.8 5.92 2.1 3.51Zm7.78 10.6 1.41 1.41-1.41 1.41a2 2 0 1 0 2.83 2.83l1.41-1.41 1.41 1.41-1.41 1.41a4 4 0 1 1-5.66-5.66l1.41-1.41Zm5.66-5.66 1.41 1.41-1.41 1.41-1.41-1.41 1.41-1.41Z"/></svg>
        <span>DISCONNECT</span>
      </button>
    </div>
  </div>

  <div class="footer">KNIGHT RIDER WEB REMOTE CONTROL SYSTEM</div>

</div>

<audio id="sScan" src="./scan.mp3" preload="auto"></audio>
<audio id="sConn" src="./connect.mp3" preload="auto"></audio>
<audio id="sBtn"  src="./button.mp3" preload="auto"></audio>

<script>
(() => {
  const SVC_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const RX_UUID  = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
  const TX_UUID  = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

  const $ = (id)=>document.getElementById(id);

  const btnScan       = $("btnScan");
  const btnConnect    = $("btnConnect");
  const btnDisconnect = $("btnDisconnect");

  const statusText = $("statusText");
  const bleText    = $("bleText");
  const deviceText = $("deviceText");
  const idText     = $("idText");
  const scanText   = $("scanText");
  const scannerState = $("scannerState");

  const sScan = $("sScan");
  const sConn = $("sConn");
  const sBtn  = $("sBtn");

  let device=null, server=null, rxChar=null, txChar=null;
  let connected=false;

  // Scanner
  const scanbar = $("scanbar");
  let scanPos=0, scanDir=1, scanTimer=null;
  for (let i=0;i<8;i++){
    const d=document.createElement("div");
    d.className="led";
    scanbar.appendChild(d);
  }
  function renderScanner(){
    const leds=[...scanbar.children];
    leds.forEach(d=>d.className="led");
    if(!connected) return;
    for(let i=0;i<8;i++){
      const dist=Math.abs(i-scanPos);
      if(dist===0) leds[i].classList.add("on");
      else if(dist===1) leds[i].classList.add("tail1");
      else if(dist===2) leds[i].classList.add("tail2");
    }
  }
  function startScanner(){
    stopScanner();
    scanPos=0; scanDir=1;
    renderScanner();
    scanTimer=setInterval(()=>{
      scanPos += scanDir;
      if(scanPos>=7){ scanPos=7; scanDir=-1; }
      else if(scanPos<=0){ scanPos=0; scanDir=1; }
      renderScanner();
    },150);
  }
  function stopScanner(){
    if(scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    [...scanbar.children].forEach(d=>d.className="led");
  }

  function audioOnce(a){
    try{
      a.pause(); a.currentTime=0;
      const p=a.play(); if(p && p.catch) p.catch(()=>{});
    }catch(_){}
  }

  function setEnabledForConnected(isConn){
    connected=isConn;

    btnConnect.disabled = (device==null) || isConn;
    btnDisconnect.disabled = !isConn;

    statusText.textContent = isConn ? "LINK: ESTABLISHED" : "LINK: NOT CONNECTED";
    scannerState.textContent = isConn ? "ACTIVE" : "OFFLINE";
    scannerState.style.color = isConn ? "var(--red)" : "var(--dim)";
    scanText.textContent = isConn ? "CONNECTED — SCAN SEQUENCE RUNNING" : "CONNECT TO ENABLE SCAN SEQUENCE";

    if(isConn) startScanner(); else stopScanner();
  }

  async function doScanPickDevice(){
    if(!navigator.bluetooth){
      bleText.textContent="BLE: NOT SUPPORTED (Use Chrome/Edge)";
      alert("此瀏覽器不支援 Web Bluetooth。\n請用 Android Chrome / PC Chrome / Edge。\niOS Safari/Chrome 不支援。");
      return;
    }

    audioOnce(sScan);
    bleText.textContent="BLE: READY";

    // ✅ 改成第一版風格：acceptAllDevices + optionalServices
    // 讓 chooser 更容易顯示名稱（前提仍是裝置有廣播 Local Name）
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SVC_UUID],
    });

    deviceText.textContent = "DEVICE: " + (device.name && device.name.trim() ? device.name : "(Unnamed)");
    idText.textContent = "ID: " + (device.id || "-");
    btnConnect.disabled = false;
  }

  async function doConnect(){
    if(!device) return;
    audioOnce(sBtn);

    try{
      device.addEventListener("gattserverdisconnected", onDisconnected);

      server = await device.gatt.connect();
      const svc = await server.getPrimaryService(SVC_UUID);
      rxChar = await svc.getCharacteristic(RX_UUID);

      // optional notify
      try{
        txChar = await svc.getCharacteristic(TX_UUID);
        if(txChar.properties.notify){
          await txChar.startNotifications();
        }
      }catch(_){}

      setEnabledForConnected(true);
      audioOnce(sConn);
    }catch(e){
      alert("CONNECT FAILED: " + (e?.message || e));
      onDisconnected();
    }
  }

  function doDisconnect(){
    audioOnce(sBtn);
    try{
      if(txChar){ try{ txChar.stopNotifications(); }catch(_){} }
      if(device?.gatt?.connected) device.gatt.disconnect();
    }catch(_){}
    onDisconnected();
  }

  function onDisconnected(){
    setEnabledForConnected(false);
    server=null; rxChar=null; txChar=null;
    btnConnect.disabled = (device==null);
  }

  btnScan.addEventListener("click", async ()=>{ try{ await doScanPickDevice(); }catch(_){} });
  btnConnect.addEventListener("click", async ()=>{ await doConnect(); });
  btnDisconnect.addEventListener("click", ()=>{ doDisconnect(); });

  setEnabledForConnected(false);
})();
</script>
</body>
</html>
